#!/usr/bin/env ruby

require 'optparse'
require 'methadone'
require 'nombus'
require 'csv'
require 'dnsruby'
require 'wre_dns'

class App
  include Methadone::Main
  include Methadone::CLILogging

  main do |input_file, output_file|
    # Parse options into appropriate types
    servers = options['nameservers'].split
    column = options['column'].to_i
    dns = Dnsruby::DNS.new( {:nameserver=>servers} )
    domain_file = CSV.open(input_file)
    output_file = Nombus::OutputFileName if not output_file
    nombus_domains = CSV.open(output_file, "wb")
    # Add headers from 1st line to output if there are any
    nombus_domains << domain_file.readline unless options['no-headers']
    domain_file.each do |row|
    	domain = Dnsruby::Name.create row[column]
    	info 'Checking domain: ' + domain.to_s
    	begin
    	  name_server = dns.getresource(domain, Dnsruby::Types.SOA).mname
        a_record = dns.getresource(domain, Dnsruby::Types.A).address		
        # if it doesn't have our namserver but does have one of our
        # old ip addresses then we found one that we want to record.
        debug domain.to_s + ', using our server? ' + (WreDns::NameServer == name_server).to_s
        debug domain.to_s + ', using one of our old ips? ' + (WreDns::OldAcomIps.include? a_record).to_s
        debug domain.to_s + ', not managed by us? ' + (Nombus.NotManagedByUs?(WreDns::NameServer, name_server, WreDns::OldAcomIps, a_record)).to_s
        if Nombus.NotManagedByUs?(WreDns::NameServer, name_server, WreDns::OldAcomIps, a_record)
        	# Ignore if we've already set them up with the current IP.
        	unless a_record == WreDns::AcomIp
        		info domain.to_s + ': not managed by us.'
        		nombus_domains << row
        	end
        end
      rescue Dnsruby::NXDomain
        warn 'No records for ' + domain.to_s
        next
      end
    end
  end
  
  # Configure command line options/arguments and build the help menu.
  version Nombus::Version
  description 'Check if domain names are managed by Windermere DNS servers'
  options['separator'] = Nombus::DefaultSeparator
  on "-s SEPARATOR", "--separator","Column separator for csv file"
  options['column'] = Nombus::Column
  on "-c", "--column", "The column where the domain name is stored in the csv file"
  options['nameservers'] = Nombus::DefaultNameservers
  on "-n LIST", "--nameservers",	"The list of nameservers to query"
  on "--no-headers", "Specify if the csv file has no headers, default assumes headers exist"
  arg :csv_file, "Path to a CSV file with a list of domain names"
  arg :output_file, :optional, "Path to a CSV file which only includes domains that are not managed by Windermere. If none specified then current working directory."
  use_log_level_option

  go!
end
